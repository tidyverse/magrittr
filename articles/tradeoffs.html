<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Design tradeoffs • magrittr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<meta property="og:title" content="Design tradeoffs">
<meta property="og:description" content="magrittr">
<meta property="og:image" content="https://magrittr.tidyverse.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">magrittr</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.5.0.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/magrittr.html">Intro</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidyverse/magrittr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Design tradeoffs</h1>
                        <h4 class="author">Hadley Wickham</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/magrittr/blob/master/vignettes/tradeoffs.Rmd"><code>vignettes/tradeoffs.Rmd</code></a></small>
      <div class="hidden name"><code>tradeoffs.Rmd</code></div>

    </div>

    
    
<p>There are many different ways that magrittr could implement the pipe. The goal of this document is to elucidate the variations, and the various pros and cons of each approach. This document is primarily aimed at the magrittr developers (so we don’t forget about important considerations), but will be of interest to anyone who wants to understand pipes better, or to create their own pipe that makes different tradeoffs</p>
<div id="code-transformation" class="section level2">
<h2 class="hasAnchor">
<a href="#code-transformation" class="anchor"></a>Code transformation</h2>
<p>There are three main options for how we might transform a pipeline in base R expressions. Here they are illustrated with <code>x %&gt;% foo() %&gt;% bar()</code>:</p>
<ul>
<li>
<p><strong>Nested</strong></p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span>(<span class="fu">foo</span>(<span class="no">x</span>))</pre></body></html></div>
</li>
<li>
<p><strong>Eager</strong></p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">.</span> <span class="kw">&lt;-</span> <span class="fu">foo</span>(<span class="no">x</span>)
<span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span>(<span class="no">.</span>)</pre></body></html></div>
</li>
<li>
<p><strong>Lazy</strong></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">...1</span> <span class="kw">&lt;-</span> <span class="no">x</span>
<span class="no">...2</span> <span class="kw">%&lt;~%</span> <span class="fu">foo</span>(<span class="no">...1</span>)
<span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span>(<span class="no">...1</span>)</pre></body></html></div>
</li>
</ul>
<p>(There is a fourth option, which uses eager evaluation, but uses a unique variable name for each stage. This has no advantages compared to the eager pipe so we will not consider it further.)</p>
<p>We’ll first explore the desired properties we might want a pipe to possess and then see how each of the three variants does.</p>
<div id="desired-properties" class="section level3">
<h3 class="hasAnchor">
<a href="#desired-properties" class="anchor"></a>Desired properties</h3>
<p>These are the properties that we might want a pipe to possess, roughly ordered from most important to leasy important.</p>
<ul>
<li><p>Visibility: the visibility of the final function in the pipe should be preserved. This important so that pipes that end in a side-effect function (which generally return their first argument invisibly) do not print.</p></li>
<li><p>Lazy evaluation: are steps of the pipe only evaluated lazily when actually needed? This is a useful property as it means that pipes can handle code like <code>stop("!") %&gt;% try()</code>, making pipes capable of capturing a wider range of R expressions.</p></li>
<li><p>Eager unbinding: pipes are often used with large data objects, so intermediate objects in the pipeline should be unbound as soon as possible so they are available for garbage collection.</p></li>
<li><p>Single evaluation: each component of the pipe should only be evaluated once, so that <code>sample(10) %&gt;% cbind(., .)</code> yields two columns with the same value, and <code>sample(10) %T&gt;% print() %T&gt;% print()</code> prints the same values twice.</p></li>
<li><p>Minimal stack: using the pipe should add as few entries to the call stack as possible, so that <code><a href="https://rdrr.io/r/base/traceback.html">traceback()</a></code> is maximally useful.</p></li>
</ul>
</div>
<div id="nested-pipe" class="section level3">
<h3 class="hasAnchor">
<a href="#nested-pipe" class="anchor"></a>Nested pipe</h3>
<ul>
<li><p>Visibility: ✅</p></li>
<li><p>Lazy evaluation: ✅</p></li>
<li><p>Eager unbinding: ✅</p></li>
<li>
<p>Single evaluation: ❌ trivial for simple pipes, but not possible for pipes that use the pronoun in multiple places.</p>
<p>Note that the simplest rewrite doesn’t work because there’s no gaurantee that the first argument will be evaluated before the second argument.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu">foo</span>(<span class="no">.</span>, <span class="no">.</span>)
<span class="fu">foo</span>(<span class="no">.</span> <span class="kw">&lt;-</span> <span class="no">x</span>, <span class="no">.</span>)</pre></body></html></div>
</li>
<li><p>Minimal stack: ❌ maximum stack depth is the length of the pipe.</p></li>
</ul>
</div>
<div id="eager-pipe" class="section level3">
<h3 class="hasAnchor">
<a href="#eager-pipe" class="anchor"></a>Eager pipe</h3>
<ul>
<li>
<p>Visibility: ✅.</p>
<p>Note that the final computation must be handled differently, as the following transformation loses visibility.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">.</span> <span class="kw">&lt;-</span> <span class="fu">foo</span>(<span class="no">.</span>)
<span class="no">.</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span>(<span class="no">.</span>)
<span class="no">.</span></pre></body></html></div>
</li>
<li><p>Lazy evaluation: ❌ assignment forces eager evaluation of each step.</p></li>
<li><p>Eager clean up: ✅</p></li>
<li><p>Single evaluation: ✅</p></li>
<li><p>Minimal stack: ✅ maximum stack depth is 1.</p></li>
</ul>
</div>
<div id="lazy-pipe" class="section level3">
<h3 class="hasAnchor">
<a href="#lazy-pipe" class="anchor"></a>Lazy pipe</h3>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">`%&lt;~%`</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">name</span>, <span class="no">value</span>, <span class="no">env</span> <span class="kw">=</span> <span class="fu">caller_env</span>()) {
  <span class="no">name</span> <span class="kw">&lt;-</span> <span class="fu">ensym</span>(<span class="no">name</span>)
  <span class="no">value</span> <span class="kw">&lt;-</span> <span class="fu">enexpr</span>(<span class="no">value</span>)

  <span class="fu">env_bind_exprs</span>(<span class="no">env</span>, <span class="kw">.eval_env</span> <span class="kw">=</span> <span class="no">env</span>, !!<span class="no">name</span> <span class="kw">:=</span> !!<span class="no">value</span>)
}</pre></body></html></div>
<ul>
<li><p>Visibility: ✅</p></li>
<li><p>Lazy evaluation: ✅</p></li>
<li>
<p>Eager clean up: ❌/✅ can be preserved by inserting a function call after each lazy assignment:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">...2</span> <span class="kw">%&lt;~%</span> <span class="fu">foo</span>(<span class="no">...1</span>)
<span class="fu">delayed_cleanup</span>()
<span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span>(<span class="no">...1</span>)</pre></body></html></div>
<p><code>delayed_cleanup()</code> would be a C function that iterates through all bindings in an environment, deleting any promises that have already been forced.</p>
</li>
<li><p>Single evaluation: ✅ by property of promises.</p></li>
<li><p>Minimal stack: ✅ maximum stack depth is 1.</p></li>
</ul>
</div>
</div>
<div id="execution-environment" class="section level2">
<h2 class="hasAnchor">
<a href="#execution-environment" class="anchor"></a>Execution environment</h2>
<p>Once the pipe has been transformed to a regular R expression, it must be evaluated. There are three options for where that evaluation could take place:</p>
<ul>
<li>In the <strong>current</strong> environment.</li>
<li>In a <strong>new</strong> environment.</li>
<li>In a <strong>closure</strong> environment, the environment of a new function.</li>
</ul>
<p>This choice affects impacts functions that work with the current environment (like <code><a href="https://rdrr.io/r/base/assign.html">assign()</a></code>, <code><a href="https://rdrr.io/r/base/get.html">get()</a></code>, <code><a href="https://rdrr.io/r/base/ls.html">ls()</a></code>), or the current context (like <code><a href="https://rdrr.io/r/base/function.html">return()</a></code>). The following two functions illustrate the primary differences:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">f</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">20</span>
  <span class="fl">10</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="st">"x"</span>, <span class="no">.</span>)
  <span class="no">x</span>
}

<span class="no">g</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="fl">10</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>()
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fl">20</span>)
}</pre></body></html></div>
<ul>
<li><p>If evaluated in the current environment, both <code>f()</code> and <code>g()</code> return 10.</p></li>
<li><p>If evaluated in a new environment, <code>f()</code> returns 20 and <code>g()</code> returns 10. NOT TRUE! Why not?</p></li>
<li><p>If evaluated in a closure environment, both <code>f()</code> and <code>g()</code> return 20.</p></li>
</ul>
<p>To discuss implementation challenges with a concrete example, we’ll take the following values:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">double</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span> * <span class="fl">2</span>
<span class="no">increment</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span> + <span class="fl">1</span>
<span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span>:<span class="fl">10</span></pre></body></html></div>
<p>And implement the following simple pipe:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>() <span class="kw">%&gt;%</span> <span class="fu">increment</span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>()</pre></body></html></div>
<p>Using the eager transformation:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">pipe</span> <span class="kw">&lt;-</span> <span class="fu">expr</span>({
  <span class="no">.</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>(<span class="no">.</span>)
  <span class="no">.</span> <span class="kw">&lt;-</span> <span class="fu">increment</span>(<span class="no">.</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>(<span class="no">.</span>)
})</pre></body></html></div>
<p>Note that we assume the input to the pipe is called <code>.</code>, not <code>x</code>. This is a small simplification that makes implementation of the transformer a little easier.</p>
<div id="closure-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#closure-environment" class="anchor"></a>Closure environment</h3>
<p>To evaluate the pipe in a closure environment, we first create a function, using the pipe fragment as body and a single argument (<code>.</code>):</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">pipe_fun</span> <span class="kw">&lt;-</span> <span class="fu">new_function</span>(<span class="fu">exprs</span>(<span class="kw">.</span> <span class="kw">=</span> ), <span class="no">pipe</span>)
<span class="no">pipe_fun</span>
<span class="co">#&gt; function (.) </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     . &lt;- double(.)</span>
<span class="co">#&gt;     . &lt;- increment(.)</span>
<span class="co">#&gt;     double(.)</span>
<span class="co">#&gt; }</span></pre></body></html></div>
<p>And then we call it with <code>x</code>:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu">pipe_fun</span>(<span class="no">x</span>)
<span class="co">#&gt;  [1]  6 10 14 18 22 26 30 34 38 42</span></pre></body></html></div>
<p>Evaluating the pipe in this way makes it clear that building functions with the pipe is the general case, and providing an initial value is the special case. In other words:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>() <span class="kw">%&gt;%</span> <span class="fu">increment</span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>()

<span class="co"># is shorthand for</span>

(<span class="no">.</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>() <span class="kw">%&gt;%</span> <span class="fu">increment</span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span>())(<span class="no">x</span>)</pre></body></html></div>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">f_closure</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">20</span>
  (<span class="kw">function</span>(<span class="no">.</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="st">"x"</span>, <span class="no">.</span>)
  })(<span class="fl">10</span>)
  <span class="no">x</span>
}
<span class="fu">f_closure</span>()
<span class="co">#&gt; [1] 20</span>

<span class="no">g_closure</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  (<span class="kw">function</span>(<span class="no">.</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">.</span>)
  })(<span class="fl">10</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fl">20</span>)
}
<span class="fu">g_closure</span>()
<span class="co">#&gt; [1] 20</span></pre></body></html></div>
</div>
<div id="new-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#new-environment" class="anchor"></a>New environment</h3>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu">eval_bare</span>(<span class="no">pipe</span>, <span class="kw">env</span> <span class="kw">=</span> <span class="fu">env</span>(<span class="kw">.</span> <span class="kw">=</span> <span class="no">x</span>))
<span class="co">#&gt;  [1]  6 10 14 18 22 26 30 34 38 42</span></pre></body></html></div>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">f_new</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">20</span>
  <span class="fu">eval_bare</span>(<span class="fu">expr</span>(<span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="st">"x"</span>, <span class="no">.</span>)), <span class="fu">env</span>(<span class="kw">.</span> <span class="kw">=</span> <span class="fl">10</span>))
  <span class="no">x</span>
}
<span class="fu">f_new</span>()
<span class="co">#&gt; [1] 20</span>

<span class="no">g_new</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="fu">eval_bare</span>(<span class="fu">expr</span>(<span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">.</span>)), <span class="fu">env</span>(<span class="kw">.</span> <span class="kw">=</span> <span class="fl">10</span>))
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fl">20</span>)
}
<span class="fu">g_new</span>()
<span class="co">#&gt; Error in eval_bare(expr(return(.)), env(. = 10)): no function to return from, jumping to top level</span></pre></body></html></div>
</div>
<div id="current-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#current-environment" class="anchor"></a>Current environment</h3>
<p>At first glance, evaluating the pipe in the current environment is quite simple:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">.</span> <span class="kw">&lt;-</span> <span class="no">x</span>
<span class="fu">eval_bare</span>(<span class="no">pipe</span>)
<span class="co">#&gt;  [1]  6 10 14 18 22 26 30 34 38 42</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">.</span>)</pre></body></html></div>
<p>And that leads to:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">f_current</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">20</span>

  <span class="no">.</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
  <span class="fu">eval_bare</span>(<span class="fu">expr</span>(<span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="st">"x"</span>, <span class="no">.</span>)))
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">.</span>)

  <span class="no">x</span>
}
<span class="fu">f_current</span>()

<span class="no">g_current</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
  <span class="no">.</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
  <span class="fu">eval_bare</span>(<span class="fu">expr</span>(<span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">.</span>)))
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">.</span>)

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fl">20</span>)
}
<span class="fu">g_current</span>()</pre></body></html></div>
<p>And this could be wrapped into a simple function so that we can ensure <code>.</code> is unbound even when an error occurs:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">pipe_eval</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">pipe</span>, <span class="no">init</span>, <span class="no">env</span> <span class="kw">=</span> <span class="fu">caller_env</span>()) {
  <span class="fu">env_bind</span>(<span class="kw">.env</span> <span class="kw">=</span> <span class="no">env</span>, <span class="kw">.</span> <span class="kw">=</span> <span class="no">init</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span>(<span class="fu">env_unbind</span>(<span class="no">env</span>, <span class="st">"."</span>))

  <span class="fu">eval_bare</span>(<span class="no">pipe</span>, <span class="no">env</span>)
}

<span class="fu">pipe_eval</span>(<span class="no">pipe</span>, <span class="no">x</span>)
<span class="co">#&gt;  [1]  6 10 14 18 22 26 30 34 38 42</span></pre></body></html></div>
<p>(This implementation will clobber any existing <code>.</code> but a more sophisticated implementation could restore any existing value on exit. Similarly, the cleanup after the lazy transformation would be more work (since it creates multiple variables), but it’s not prohibitively hard.)</p>
<p>The main drawback to this approach is that <code>eval_bare()</code> currently loses the visibility flag. This can be fixed, but needs work in C.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>magrittr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by Stefan Milton Bache, <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
